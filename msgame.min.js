const{abs:abs,floor:floor,ceil:ceil,min:min,max:max,sqrt:sqrt,random:rand}=Math,{log:log}=console;function _getArg(t,e,i){let s=t&&t[e];return void 0===s?i:s}const _isArr=Array.isArray;function _asArr(t){return void 0===t?[]:_isArr(t)?t:[t]}function _createEl(t){return document.createElement(t)}function _createCan(t,e){const i=_createEl("canvas");return i.width=t,i.height=e,i}function _ctx(t){return t.getContext("2d")}function _getCached(t,e,i){let s=t._cache;s||(s=t._cache={});let r=s[e];return void 0===r&&(r=s[e]=i()),r}function _wait(t){return new Promise((e,i)=>setTimeout(e,t))}function _mayCall(t){return"function"==typeof t?t():t}export class Pool{constructor(t,e){this.pool=[];for(let i=0;i<t;++i)this.pool.push(e());this.curIte=0}next(){const t=this.curIte,e=this.pool[t];return this.curIte=(t+1)%this.pool.length,e}}export function createCanvas(t,e,i){const s=_createCan(t,e);if(i&&i.fitWindow){const i=t/e,r=window.innerWidth,n=window.innerHeight,o=r/n;s.style.width=(i>o?r:floor(n*i))+"px",s.style.height=(i>o?floor(r/i):n)+"px"}return s}class Elem{constructor(){this.time=0}update(t){this.time+=t,this.trigger("update",t)}on(t,e){let i=this._events;i||(i=this._events={});let s=i[t];if(s||(s=i[t]={}),"function"==typeof e)for(let t=0;;++t){const i="_"+t;if(void 0===s[i])return void(s[i]=e)}else for(let t in e)s[t]=e[t]}off(t,e){if(void 0===t)return void delete this._events;let i=this._events;if(!i)return;if(void 0===e)return void delete i[t];let s=i[t];s&&delete s[e]}trigger(t,...e){let i=this._events;if(!i)return;let s=i[t];if(s)for(let t in s)!1===s[t].call(this,...e)&&delete s[t]}remove(){this.removed=!0,this.trigger("remove")}every(t,e,i){(this[t]||0)<=this.time&&(i(),this[t]+=_mayCall(e))}}export class Game extends Elem{constructor(t,e){super(),this.canvas=t,this.width=t.width,this.height=t.height,this.fps=60,this.paused=!1,Object.assign(this,e)}async initLoop(){await waitLoads(),this.start();const t=1/this.fps;let e=t;for(;;){const i=Date.now();this.paused||this.update(e),this.draw(_ctx(this.canvas),e);const s=(Date.now()-i)/1e3,r=max(0,t-s);await _wait(1e3*r),e=s+r}}start(){}draw(){}pause(t){t!==this.paused&&(this.paused=t,pauseAudios(t))}addPointerDownListener(t){this._addPointerListerner("mousedown","touchstart",t)}addPointerUpListener(t){this._addPointerListerner("mouseup","touchend",t)}addPointerMoveListener(t){this._addPointerListerner("mousemove","touchmove",t)}_addPointerListerner(t,e,i){this.canvas.addEventListener(t,t=>{i(this._getEvtPos(t))},!1),this.canvas.addEventListener(e,t=>{t.preventDefault(),i(this._getEvtPos(t.changedTouches[0]))},!1)}_getEvtPos(t){const e=this.canvas,i=this.canvas.getBoundingClientRect(),s=e.clientWidth/e.width;return{x:(t.clientX-i.left)/s,y:(t.clientY-i.top)/s}}}export class Scene extends Elem{constructor(t,e){super(),this.game=t,this.width=t.width,this.height=t.height,this.x=0,this.y=0,this.color="white",Object.assign(this,e),this.canvas=_createCan(this.width,this.height)}draw(t,e){const i=this.nextImg(e);t.drawImage(i,~~this.x,~~this.y)}nextImg(t){const e=this.canvas.getContext("2d");return e.fillStyle=this.color,e.fillRect(0,0,this.width,this.height),this.canvas}}export function strechImg(t){const{width:e,height:i}=this;return{width:e,height:i}}export function fitImg(t){const{width:e,height:i}=this,{width:s,height:r}=t,n=e/i,o=s/r;return{width:n<o?e:s*i/r,height:n>o?i:r*e/s}}export function fillImg(t){const{width:e,height:i}=this,{width:s,height:r}=t,n=e/i,o=s/r;return{width:n>o?e:s*i/r,height:n<o?i:r*e/s}}export class Sprite extends Elem{constructor(t,e){super(),this.scene=t,this.x=0,this.y=0,this.width=50,this.height=50,this.anchorX=0,this.anchorY=0,this.anim="black",this.animTime=0,Object.assign(this,e)}getBoundaries(){const{x:t,y:e,width:i,height:s,anchorX:r,anchorY:n}=this;return{x:t-i*r,y:e-s*n,width:i,height:s}}draw(t,e,i,s){const r=this.nextImg(s);if(!r)return;const{x:n,y:o}=this.getBoundaries(),h=(this.width-r.width)/2,a=(this.height-r.height)/2;t.drawImage(r,~~(n+h-e),~~(o+a-i))}nextImg(t){this.animTime+=t;let e=this.anim;if(!e)return;"string"==typeof e&&(e=this.getDefaultAnim());const i=e.getImg(this.animTime);if(!i)return;if(!this.scaleImg)return i;const s=this.scaleImg(i);return this.animFlipX&&(s.flipX=!0),this.animFlipY&&(s.flipY=!0),e.transformImg(i,s)}getDefaultAnim(){const t=this.anim;return _getCached(this.constructor,"dImg:"+t,()=>{const e=_createCan(10,10),i=_ctx(e);return i.fillStyle=t,i.fillRect(0,0,10,10),new Anim(e)})}}Sprite.prototype.scaleImg=strechImg;export const Loads=[];function _waitLoad(t){return new Promise((e,i)=>{const s=()=>t.loaded?e():t.error?i(t.error):void setTimeout(s,10);s()})}export function waitLoads(){return Promise.all(Loads.map(_waitLoad))}export class SpriteSheet{constructor(t,e){this.src=t,this.frames=[],Object.assign(this,e),this.load()}async load(){if(this.loaded)return;Loads.push(this);const t=this.img=new Img(this.src);await _waitLoad(t);const e=this.frameWidth||t.width,i=this.frameHeight||t.height,s=floor(t.width/e),r=floor(t.height/i);for(let n=0;n<r;++n)for(let r=0;r<s;++r){const o=this.getFrame(r+s*n);o.width=e,o.height=i,_ctx(o).drawImage(t,~~(-r*e),~~(-n*i))}this.loaded=!0}getFrame(t){if(_isArr(t))return t.map(t=>this.getFrame(t));const e=this.frames;for(;e.length<=t;)e.push(_createCan(0,0));return e[t]}}export class Anim{constructor(t,e){this.imgs=_asArr(t).map(t=>"string"==typeof t?new Img(t):t),this.fps=1,Object.assign(this,e)}getImg(t){const e=this.imgs;return e[floor(t*this.fps)%e.length]}transformImg(t,e){return _getCached(t,JSON.stringify(e),()=>{const i=e.width||t.width,s=e.height||t.height,r=_createCan(i,s),n=_ctx(r);return n.translate(e.flipX?i:0,e.flipY?s:0),n.scale(e.flipX?-1:1,e.flipY?-1:1),n.drawImage(t,0,0,i,s),r})}}export class Img extends Image{constructor(t,e){super(),this.src=t,Object.assign(this,e),Loads.push(this),this.onload=()=>this.loaded=!0,this.onerror=()=>this.error="load error: "+t}}export const Audios=[];export let VolumeLevel=1;export class Aud extends Audio{constructor(t,e){super(),this.src=t,this.baseVolume=1,Object.assign(this,e),this.syncVolume(),Audios.push(this),Loads.push(this),this.onloadeddata=()=>this.loaded=!0,this.onerror=()=>this.error="load error: "+t}playable(){return 0==this.currentTime||this.ended}replay(t){(_getArg(t,"force")||this.playable())&&(this.currentTime=0,Object.assign(this,t),this.syncVolume(),this.play())}syncVolume(){this.volume=this.baseVolume*VolumeLevel}}export function pauseAudios(t){Audios.forEach(e=>{if(t){if(0==e.currentTime||e.ended)return;e.pause(),e.pausedByGame=!0}else{if(!e.pausedByGame)return;e.play(),e.pausedByGame=!1}})}export function setVolumeLevel(t){VolumeLevel=t,Audios.forEach(t=>t.syncVolume())}export class AudPool extends Pool{constructor(t,e,i){super(t,()=>new Aud(e,i))}}export function sign(t){return 0===t?0:t>0?1:-1}export function bound(t,e,i){return t<e?e:t>i?i:t}export function randge(t,e){return t+rand()*(e-t)}export function range(t,e){void 0===e&&(e=t,t=0);const i=[];for(let s=t;s<e;++s)i.push(s);return i}export function accTo(t,e,i,s,r){if(t==e)return t;const n=0==t||t*e>0?i*r:s*r;return e>0||0==e&&t<0?min(t+n,e):e<0||0==e&&t>0?max(t-n,e):void 0}export function moveTo(t,e,i,s,r,n,o){const h=e-t,a=abs(h);return accTo(i,bound(sign(h)*sqrt(a*n),-s,s),r,n,o)}export function collide(t,e){t.getBoundaries&&(t=t.getBoundaries()),e.getBoundaries&&(e=e.getBoundaries());let{x:i,y:s,width:r,height:n}=t,{x:o,y:h,width:a,height:c}=e;return r|=0,n|=0,a|=0,c|=0,!(i>o+a)&&(!(o>i+r)&&(!(s>h+c)&&!(h>s+n)))}export class Text extends Sprite{getAlignText(){if(this.alignText)return this.alignText;const{anchorX:t}=this;return 0===t?"left":1===t?"right":"center"}nextImg(t){const e=_mayCall(this.value);if(e!==this.prevValue){this.prevValue=e;const t=e.split("\n"),i=this.img=_createCan(1,1),s=_ctx(i),r=s.font=this.font||"20px Georgia",n=this.lineHeight||parseInt(s.font);let o=0,h=0;for(let e of t)o=max(o,s.measureText(e).width),h+=n;this.width=i.width=ceil(o),this.height=i.height=ceil(h),s.font=r,s.fillStyle=this.color||"black",s.textAlign=this.getAlignText(),s.textBaseline="top";let a=0;"center"===s.textAlign&&(a=floor(o/2)),"right"===s.textAlign&&(a=o);for(let e in t)s.fillText(t[e],a,e*n)}return this.img}}Text.prototype.scaleImg=!1;export class Flash extends Sprite{update(t){super.update(t),this.time>this.ttl&&this.remove()}draw(t,e,i,s){const r=this.rgb||"255,255,255",n=1-this.time/this.ttl,{width:o,height:h}=this,a=min(o,h),c=a/2,l=t.createRadialGradient(c,c,.4*a,c,c,(.3*n+.7)*a);l.addColorStop(0,`rgba(${r}, 0)`),l.addColorStop(1,`rgba(${r}, ${1-n})`),o>h?t.setTransform(o/h,0,0,1,0,0):t.setTransform(1,0,0,h/o,0,0),t.fillStyle=l,t.fillRect(~~e,~~i,a,a),t.setTransform(1,0,0,1,0,0)}}Flash.prototype.ttl=.15;
